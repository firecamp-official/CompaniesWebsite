<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Éclat Studio - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f5f5f5;
            margin: 0;
        }
        .centered {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .admin-auth {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 350px;
            text-align: center;
        }
        .admin-dashboard {
            background: #fff;
            padding: 30px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            max-width: 1200px;
            margin: 40px auto;
        }
        .dashboard-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .dashboard-header h2 {
            margin: 0 0 10px 0;
            font-size: 2rem;
        }
        .logout-btn {
            background: #555;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .logout-btn:hover {
            background: #333;
        }
        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0 10px 0;
        }
        .filters-bar input[type="text"] {
            flex: 1 1 200px;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .filters-bar select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .appointments-table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        th, td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
            font-size: 1rem;
        }
        th {
            background: #ff6600;
            color: #fff;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover {
            background: #fff6ee;
            transition: background 0.2s;
        }
        .action-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            margin-right: 6px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .approve-btn {
            background: #4caf50;
            color: #fff;
        }
        .approve-btn:hover {
            background: #388e3c;
        }
        .delete-btn {
            background: #f44336;
            color: #fff;
        }
        .delete-btn:hover {
            background: #b71c1c;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            color: #fff;
        }
        .status-pending { background: #ff9800; }
        .status-approved { background: #4caf50; }
        .status-rejected { background: #f44336; }
        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            margin: 18px 0 0 0;
        }
        .pagination-btn {
            background: #eee;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .pagination-btn.active, .pagination-btn:hover {
            background: #ff6600;
            color: #fff;
        }
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            min-width: 220px;
            background: #323232;
            color: #fff;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            font-size: 1.1em;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            transition: opacity 0.3s, top 0.3s;
        }
        .notification.show {
            opacity: 1;
            pointer-events: auto;
            top: 50px;
        }
        @media (max-width: 900px) {
            .admin-dashboard {
                padding: 18px 2vw;
                max-width: 98vw;
            }
            th, td {
                font-size: 0.97rem;
                padding: 10px 6px;
            }
        }
        @media (max-width: 600px) {
            .admin-dashboard {
                padding: 10px 0.5vw;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .dashboard-header, .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            .appointments-table-container {
                padding: 0;
            }
        }
    </style>
</head>

<body>

    <!-- Connexion Admin -->
    <div class="centered">
        <section class="admin-auth">
            <h2>Connexion Admin</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Mot de passe">
            <button id="loginBtn">Se connecter</button>
            <p id="loginError"></p>
        </section>
    </div>
    <!-- Dashboard Admin (caché au départ) -->
    <section class="admin-dashboard" style="display:none;">
        <div class="dashboard-header">
            <h2>Gestion des rendez-vous</h2>
            <button class="logout-btn" id="logoutBtn">Se déconnecter</button>
        </div>
        <div class="filters-bar">
            <input type="text" id="searchInput" placeholder="Rechercher par nom, email, message...">
            <select id="statusFilter">
                <option value="">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="approved">Approuvé</option>
                <option value="rejected">Rejeté</option>
            </select>
        </div>
        <div class="appointments-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                        <th>Service</th>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Message</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="appointmentsTable">
                    <!-- Les RDV vont arriver ici -->
                </tbody>
            </table>
        </div>
        <div class="pagination" id="pagination"></div>
        <div class="notification" id="notification"></div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    // === Initialisation Supabase ===
    const supabaseClient = supabase.createClient(
        'https://apiisvdmuzwkdklyjruz.supabase.co',
        'sb_publishable_blxszWKxKm1wqzohJ0byxQ_7M_fs9I6'
    );

    // --- Login logic (do not change) ---
    const loginError = document.getElementById("loginError");
    document.getElementById("loginBtn").addEventListener("click", async () => {
        loginError.textContent = "";
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        if (!email || !password) {
            loginError.textContent = "Veuillez remplir tous les champs";
            return;
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
            loginError.textContent = "Email ou mot de passe incorrect";
            return;
        }
        await checkAdmin();
    });
    async function checkAdmin() {
        const { data, error } = await supabaseClient.auth.getUser();
        const user = data?.user;
        if (!user) {
            loginError.textContent = "Erreur: utilisateur non trouvé";
            return;
        }
        const { data: profile, error: profileError } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', user.id)
            .single();
        if (profileError || !profile) {
            loginError.textContent = "Impossible de récupérer le rôle";
            return;
        }
        if (profile.role === 'admin') {
            document.querySelector(".admin-auth").style.display = "none";
            document.querySelector(".admin-dashboard").style.display = "block";
            AppointmentsModule.init();
        } else {
            loginError.textContent = "Accès réservé aux administrateurs";
            await supabaseClient.auth.signOut();
        }
    }
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await supabaseClient.auth.signOut();
        document.querySelector(".admin-dashboard").style.display = "none";
        document.querySelector(".admin-auth").style.display = "block";
    });
    window.addEventListener("load", async () => {
        const { data } = await supabaseClient.auth.getUser();
        if (data?.user) {
            await checkAdmin();
        }
    });

    // --- Appointments Module ---
    const AppointmentsModule = (() => {
        // Config
        const PAGE_SIZE = 10;
        // State
        let allAppointments = [];
        let filteredAppointments = [];
        let currentPage = 1;
        let currentStatus = '';
        let currentSearch = '';

        // DOM
        const tableBody = document.getElementById("appointmentsTable");
        const searchInput = document.getElementById("searchInput");
        const statusFilter = document.getElementById("statusFilter");
        const paginationDiv = document.getElementById("pagination");
        const notificationDiv = document.getElementById("notification");

        // --- Utility: Notification ---
        function showNotification(message, type = 'success') {
            notificationDiv.textContent = message;
            notificationDiv.style.background = type === 'success' ? '#4caf50' : '#f44336';
            notificationDiv.classList.add('show');
            setTimeout(() => notificationDiv.classList.remove('show'), 2200);
        }

        // --- Utility: Format Date/Time ---
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR');
        }
        function formatTime(dateStr, timeStr) {
            if (timeStr) return timeStr;
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        // --- Fetch appointments from Supabase ---
        async function fetchAppointments() {
            const { data, error } = await supabaseClient
                .from('appointments')
                .select('*')
                .order('date', { ascending: true });
            if (error) {
                showNotification("Impossible de charger les rendez-vous", 'error');
                return [];
            }
            return data || [];
        }

        // --- Render Table ---
        function renderTable() {
            tableBody.innerHTML = '';
            const startIdx = (currentPage - 1) * PAGE_SIZE;
            const pageData = filteredAppointments.slice(startIdx, startIdx + PAGE_SIZE);
            if (pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Aucun rendez-vous trouvé.</td></tr>`;
                renderPagination();
                return;
            }
            for (const rdv of pageData) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rdv.name || '-'}</td>
                    <td>${rdv.email || '-'}</td>
                    <td>${rdv.phone || '-'}</td>
                    <td>${rdv.service || '-'}</td>
                    <td>${formatDate(rdv.date)}</td>
                    <td>${formatTime(rdv.date, rdv.time)}</td>
                    <td>${rdv.message || '-'}</td>
                    <td>
                        <span class="status-badge status-${rdv.status || 'pending'}">
                            ${statusLabel(rdv.status)}
                        </span>
                    </td>
                    <td>
                        ${rdv.status !== 'approved' ? `<button class="action-btn approve-btn" data-id="${rdv.id}">Approuver</button>` : ''}
                        <button class="action-btn delete-btn" data-id="${rdv.id}">Supprimer</button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
            renderPagination();
        }

        // --- Render Pagination ---
        function renderPagination() {
            paginationDiv.innerHTML = '';
            const totalPages = Math.ceil(filteredAppointments.length / PAGE_SIZE);
            if (totalPages <= 1) return;
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
                btn.textContent = i;
                btn.addEventListener('click', () => {
                    currentPage = i;
                    renderTable();
                });
                paginationDiv.appendChild(btn);
            }
        }

        // --- Status Label ---
        function statusLabel(status) {
            switch (status) {
                case 'approved': return 'Approuvé';
                case 'rejected': return 'Rejeté';
                default: return 'En attente';
            }
        }

        // --- Filter & Search ---
        function applyFilters() {
            let arr = [...allAppointments];
            if (currentStatus) {
                arr = arr.filter(r => (r.status || 'pending') === currentStatus);
            }
            if (currentSearch) {
                const s = currentSearch.toLowerCase();
                arr = arr.filter(r =>
                    (r.name && r.name.toLowerCase().includes(s)) ||
                    (r.email && r.email.toLowerCase().includes(s)) ||
                    (r.message && r.message.toLowerCase().includes(s))
                );
            }
            filteredAppointments = arr;
            currentPage = 1;
            renderTable();
        }

        // --- Approve Appointment ---
        async function approveAppointment(id) {
            const { error } = await supabaseClient
                .from('appointments')
                .update({ status: 'approved' })
                .eq('id', id);
            if (error) {
                showNotification("Erreur lors de l'approbation", 'error');
            } else {
                showNotification("Rendez-vous approuvé !", 'success');
                await refresh();
            }
        }

        // --- Delete Appointment ---
        async function deleteAppointment(id) {
            if (!confirm('Supprimer ce rendez-vous ?')) return;
            const { error } = await supabaseClient
                .from('appointments')
                .delete()
                .eq('id', id);
            if (error) {
                showNotification("Erreur lors de la suppression", 'error');
            } else {
                showNotification("Rendez-vous supprimé.", 'success');
                await refresh();
            }
        }

        // --- Event Delegation for Actions ---
        function setupActionListeners() {
            tableBody.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                if (btn.classList.contains('approve-btn')) {
                    await approveAppointment(id);
                } else if (btn.classList.contains('delete-btn')) {
                    await deleteAppointment(id);
                }
            });
        }

        // --- Setup Filters ---
        function setupFilters() {
            searchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value.trim();
                applyFilters();
            });
            statusFilter.addEventListener('change', (e) => {
                currentStatus = e.target.value;
                applyFilters();
            });
        }

        // --- Refresh Data ---
        async function refresh() {
            allAppointments = await fetchAppointments();
            applyFilters();
        }

        // --- Public Init ---
        function init() {
            setupActionListeners();
            setupFilters();
            refresh();
        }

        // --- Expose for future extensibility ---
        return {
            init,
            refresh,
            approveAppointment,
            deleteAppointment,
            // For future: bulkApprove, bulkDelete, exportCSV, assignToUser, etc.
        };
    })();
    </script>


</body>

</html>